---
import '../styles/global.css';
import Navbar from '../components/layout/Navbar.astro';
import Footer from '../components/layout/Footer.astro';

/**
 * DashboardLayout - Layout dla sekcji dashboard
 * Features:
 * - Sidebar z nawigacją do sekcji dashboard
 * - Responsive: sidebar drawer na mobile, fixed sidebar na desktop
 * - Navbar i Footer
 * - Auth protection handled by AuthGuard component (client-side)
 */

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'Dashboard | mkrew',
  description = 'Panel użytkownika platformy mkrew',
} = Astro.props;

/**
 * Auth check is handled by AuthGuard component (client-side)
 * Each dashboard page wraps its content with <AuthGuard>
 */

/**
 * Dashboard navigation items
 */
interface DashboardNavItem {
  label: string;
  href: string;
  icon: string; // SVG path data
  description?: string;
}

const dashboardNavItems: DashboardNavItem[] = [
  {
    label: 'Dashboard',
    href: '/dashboard',
    icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6',
    description: 'Przegląd',
  },
  {
    label: 'Donacje',
    href: '/dashboard/donations',
    icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01',
    description: 'Historia donacji',
  },
  {
    label: 'Ulubione',
    href: '/dashboard/favorites',
    icon: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z',
    description: 'Ulubione centra',
  },
  {
    label: 'Powiadomienia',
    href: '/dashboard/notifications',
    icon: 'M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9',
    description: 'Powiadomienia',
  },
  {
    label: 'Profil',
    href: '/dashboard/profile',
    icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z',
    description: 'Ustawienia konta',
  },
];

// Pobierz aktualną ścieżkę dla active state
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <title>{title}</title>

    <!-- Inject runtime environment variables for client-side access -->
    <script is:inline define:vars={{
      PUBLIC_API_BASE_URL: import.meta.env.PUBLIC_API_BASE_URL
    }}>
      window.__ENV__ = window.__ENV__ || {};
      window.__ENV__.PUBLIC_API_BASE_URL = PUBLIC_API_BASE_URL;
    </script>

    <slot name="head" />
  </head>
  <body class="flex flex-col min-h-screen bg-gray-50">
    <!-- Navbar -->
    <Navbar />

    <div class="flex-1 flex">
      <!-- Sidebar - Desktop -->
      <aside
        id="dashboard-sidebar"
        class="hidden lg:flex lg:flex-col lg:w-64 lg:fixed lg:inset-y-0 lg:pt-16 bg-white border-r border-gray-200"
      >
        <div class="flex-1 flex flex-col overflow-y-auto pt-5 pb-4">
          <nav class="flex-1 px-4 space-y-1">
            {dashboardNavItems.map((item) => {
              const isActive =
                currentPath === item.href ||
                (item.href !== '/dashboard' && currentPath.startsWith(item.href));

              return (
                <a
                  href={item.href}
                  class={`group flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors ${
                    isActive
                      ? 'bg-primary-50 text-primary-600'
                      : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'
                  }`}
                  aria-current={isActive ? 'page' : undefined}
                >
                  <svg
                    class={`mr-3 flex-shrink-0 h-6 w-6 ${
                      isActive ? 'text-primary-600' : 'text-gray-400 group-hover:text-gray-500'
                    }`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d={item.icon}
                    />
                  </svg>
                  <div class="flex-1">
                    <div>{item.label}</div>
                    {item.description && (
                      <div class="text-xs text-gray-500 mt-0.5">
                        {item.description}
                      </div>
                    )}
                  </div>
                </a>
              );
            })}
          </nav>

          <!-- Sidebar Footer - Quick actions -->
          <div class="px-4 pt-4 border-t border-gray-200">
            <a
              href="/rckik"
              class="group flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <svg
                class="mr-3 flex-shrink-0 h-6 w-6 text-gray-400 group-hover:text-gray-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              Szukaj centrum
            </a>
          </div>
        </div>
      </aside>

      <!-- Mobile Sidebar Overlay -->
      <div
        id="mobile-sidebar-overlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 lg:hidden hidden"
        aria-hidden="true"
      ></div>

      <!-- Mobile Sidebar -->
      <aside
        id="mobile-sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-white transform -translate-x-full transition-transform duration-300 ease-in-out lg:hidden"
      >
        <div class="flex flex-col h-full pt-5 pb-4">
          <!-- Close button -->
          <div class="flex items-center justify-between px-4 mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Menu</h2>
            <button
              id="mobile-sidebar-close"
              class="p-2 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors"
              aria-label="Zamknij menu"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Navigation -->
          <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
            {dashboardNavItems.map((item) => {
              const isActive =
                currentPath === item.href ||
                (item.href !== '/dashboard' && currentPath.startsWith(item.href));

              return (
                <a
                  href={item.href}
                  class={`group flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors ${
                    isActive
                      ? 'bg-primary-50 text-primary-600'
                      : 'text-gray-700 hover:bg-gray-50'
                  }`}
                >
                  <svg
                    class={`mr-3 flex-shrink-0 h-6 w-6 ${
                      isActive ? 'text-primary-600' : 'text-gray-400'
                    }`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d={item.icon}
                    />
                  </svg>
                  {item.label}
                </a>
              );
            })}
          </nav>

          <!-- Mobile Sidebar Footer -->
          <div class="px-4 pt-4 border-t border-gray-200">
            <a
              href="/rckik"
              class="group flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <svg
                class="mr-3 flex-shrink-0 h-6 w-6 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              Szukaj centrum
            </a>
          </div>
        </div>
      </aside>

      <!-- Mobile Sidebar Toggle Button (Floating) -->
      <button
        id="mobile-sidebar-toggle"
        class="fixed bottom-6 left-6 z-30 lg:hidden p-3 rounded-full bg-primary-600 text-white shadow-lg hover:bg-primary-700 transition-colors"
        aria-label="Otwórz menu"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          />
        </svg>
      </button>

      <!-- Main Content -->
      <main class="flex-1 lg:pl-64">
        <div class="py-6 px-4 sm:px-6 lg:px-8">
          <slot />
        </div>
      </main>
    </div>

    <!-- Footer -->
    <Footer />

    <!-- Mobile Sidebar Toggle Script -->
    <script>
      // Mobile sidebar functionality
      const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
      const mobileSidebar = document.getElementById('mobile-sidebar');
      const mobileSidebarClose = document.getElementById('mobile-sidebar-close');
      const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');

      function openMobileSidebar() {
        if (mobileSidebar && mobileSidebarOverlay) {
          mobileSidebar.classList.remove('-translate-x-full');
          mobileSidebarOverlay.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      }

      function closeMobileSidebar() {
        if (mobileSidebar && mobileSidebarOverlay) {
          mobileSidebar.classList.add('-translate-x-full');
          mobileSidebarOverlay.classList.add('hidden');
          document.body.style.overflow = '';
        }
      }

      // Toggle button
      mobileSidebarToggle?.addEventListener('click', openMobileSidebar);

      // Close button
      mobileSidebarClose?.addEventListener('click', closeMobileSidebar);

      // Overlay click
      mobileSidebarOverlay?.addEventListener('click', closeMobileSidebar);

      // Close on navigation (click on sidebar links)
      mobileSidebar?.querySelectorAll('a').forEach((link) => {
        link.addEventListener('click', closeMobileSidebar);
      });

      // Close on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeMobileSidebar();
        }
      });
    </script>
  </body>
</html>
