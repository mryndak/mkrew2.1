---
/**
 * Widok szczegółów RCKiK
 * Route: /rckik/[id]
 *
 * User Story: US-008 - "Szczegóły RCKiK: Jako użytkownik chcę zobaczyć szczegóły konkretnego RCKiK,
 * historię snapshotów i trend."
 *
 * Strategia renderowania:
 * - SSR (Server-Side Rendering) - strony renderowane on-demand
 * - Pozwala na dynamiczne ładowanie szczegółów RCKiK bez konieczności rebuildowania
 * - Publiczny dostęp (bez wymaganej autoryzacji)
 */

import Layout from '../../layouts/Layout.astro';
import SEO from '../../components/SEO.astro';
import Breadcrumbs from '../../components/common/Breadcrumbs.astro';
import RckikNotFound from '../../components/rckik/details/RckikNotFound.astro';
import { RckikHeader } from '../../components/rckik/details/RckikHeader';
import { BloodLevelBadge } from '../../components/rckik/BloodLevelBadge';
import { BloodLevelChart } from '../../components/rckik/details/BloodLevelChart';
import { HistoryTable } from '../../components/rckik/details/HistoryTable';
import { ScraperStatus } from '../../components/rckik/details/ScraperStatus';
import { ErrorState } from '../../components/common/ErrorState';

// Import API funkcji
import { fetchRckikDetails } from '../../lib/api/endpoints/rckik';

// ===== Server-Side Rendering Configuration =====

/**
 * SSR (Server-Side Rendering) Configuration
 * Strony są renderowane on-demand dla każdego żądania
 * Pozwala na wyświetlanie szczegółów dowolnego RCKiK bez konieczności rebuildowania
 */
export const prerender = false;

// ===== Page Component =====

const { id } = Astro.params;

// Validate and parse ID
if (!id || id.trim() === '') {
  return Astro.redirect('/404');
}

const rckikId = parseInt(id as string, 10);

// Validate ID is a positive number
if (isNaN(rckikId) || rckikId <= 0 || !Number.isInteger(parseFloat(id as string))) {
  return Astro.redirect('/404');
}

// Fetch RCKiK details from API
let rckik;
let rckikNotFound = false;

try {
  rckik = await fetchRckikDetails(rckikId);
} catch (error: any) {
  // Handle 404 - RCKiK nie istnieje
  if (error.response?.status === 404) {
    rckikNotFound = true;
  } else {
    // Other errors - log and show error state
    console.error('Error fetching RCKiK details:', error);

    // For development - use mock data if backend not available
    if (import.meta.env.DEV) {
      console.warn('Using mock data for development');
      rckik = {
        id: rckikId,
        name: `Regionalne Centrum Krwiodawstwa i Krwiolecznictwa w Warszawie`,
        code: `RCKIK-WAW-${rckikId}`,
        city: 'Warszawa',
        address: 'ul. Kasprzaka 17, 01-211 Warszawa',
        latitude: 52.2319,
        longitude: 20.9728,
        aliases: ['RCKiK Warszawa', 'RCKIK WAW'],
        active: true,
        createdAt: '2024-01-01T00:00:00',
        updatedAt: new Date().toISOString(),
        currentBloodLevels: [
          {
            bloodGroup: 'A+',
            levelPercentage: 45.5,
            levelStatus: 'IMPORTANT',
            lastUpdate: new Date().toISOString(),
          },
          {
            bloodGroup: '0-',
            levelPercentage: 15.0,
            levelStatus: 'CRITICAL',
            lastUpdate: new Date().toISOString(),
          },
          {
            bloodGroup: 'B+',
            levelPercentage: 65.0,
            levelStatus: 'OK',
            lastUpdate: new Date().toISOString(),
          },
          {
            bloodGroup: 'AB+',
            levelPercentage: 30.0,
            levelStatus: 'IMPORTANT',
            lastUpdate: new Date().toISOString(),
          },
          {
            bloodGroup: 'A-',
            levelPercentage: 55.0,
            levelStatus: 'OK',
            lastUpdate: new Date().toISOString(),
          },
          {
            bloodGroup: '0+',
            levelPercentage: 12.0,
            levelStatus: 'CRITICAL',
            lastUpdate: new Date().toISOString(),
          },
          {
            bloodGroup: 'B-',
            levelPercentage: 48.0,
            levelStatus: 'IMPORTANT',
            lastUpdate: new Date().toISOString(),
          },
          {
            bloodGroup: 'AB-',
            levelPercentage: 70.0,
            levelStatus: 'OK',
            lastUpdate: new Date().toISOString(),
          },
        ],
        lastSuccessfulScrape: new Date(Date.now() - 3600000).toISOString(),
        scrapingStatus: 'OK',
      };
    } else {
      // In production, rethrow the error
      throw error;
    }
  }
}

// Check if user is authenticated
const accessToken = Astro.cookies.get('accessToken')?.value;
const isAuthenticated = !!accessToken;

// Check if RCKiK is in user's favorites
let isFavorite = false;
if (isAuthenticated && rckik) {
  try {
    const { fetchFavorites } = await import('../../lib/api/endpoints/favorites');
    const favorites = await fetchFavorites();
    isFavorite = favorites.some(fav => fav.rckikId === rckikId);
  } catch (error) {
    // If fetching favorites fails, assume not favorite
    console.error('Error fetching favorites:', error);
    isFavorite = false;
  }
}

// SEO
const title = rckikNotFound
  ? `RCKiK nie znaleziono | mkrew`
  : `${rckik!.name} - Szczegóły centrum | mkrew`;
const description = rckikNotFound
  ? `Centrum RCKiK o ID ${rckikId} nie zostało znalezione.`
  : `Szczegółowe informacje o ${rckik!.name}: aktualne stany krwi, historia snapshotów i trend dla wszystkich grup krwi. ${rckik!.address}.`;

// Breadcrumbs
const breadcrumbItems = !rckikNotFound && rckik ? [
  { label: 'Strona główna', href: '/' },
  { label: 'Lista RCKiK', href: '/rckik' },
  { label: rckik.name },
] : [];
---

<Layout
  title={title}
  description={description}
  includeNavbar={true}
  includeFooter={true}
>
  <Fragment slot="head">
    <SEO
      title={title}
      description={description}
    />
  </Fragment>

  <main class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">

      {rckikNotFound ? (
        <RckikNotFound rckikId={rckikId} />
      ) : (
        <>
          <!-- Breadcrumbs -->
          <Breadcrumbs items={breadcrumbItems} />

      <!-- RckikHeader -->
      <RckikHeader
        rckik={rckik}
        isFavorite={isFavorite}
        isAuthenticated={isAuthenticated}
        onToggleFavorite={() => {
          // Handler będzie obsługiwany przez React component
          if (!isAuthenticated) {
            window.location.href = `/login?returnUrl=/rckik/${rckikId}`;
          }
        }}
        client:load
      />

      <!-- Current Blood Levels Section -->
      <section class="mb-8">
        <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-4">
          Aktualne stany krwi
        </h2>

        {rckik.currentBloodLevels && rckik.currentBloodLevels.length > 0 ? (
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
            {rckik.currentBloodLevels.map((level) => (
              <BloodLevelBadge
                bloodLevel={level}
                size="large"
                client:load
              />
            ))}
          </div>
        ) : (
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center">
            <p class="text-gray-600">Brak aktualnych danych o stanach krwi</p>
          </div>
        )}

        {rckik.currentBloodLevels[0]?.lastUpdate && (
          <p class="text-xs sm:text-sm text-gray-500 mt-3">
            Ostatnia aktualizacja: {new Date(rckik.currentBloodLevels[0].lastUpdate).toLocaleString('pl-PL', {
              day: '2-digit',
              month: 'long',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            })}
          </p>
        )}
      </section>

      <!-- Blood Level Chart Section -->
      <section class="mb-8">
        <BloodLevelChart
          rckikId={rckikId}
          initialBloodGroup="0+"
          client:visible
        />
      </section>

      <!-- History Table Section -->
      <section class="mb-8">
        <HistoryTable
          rckikId={rckikId}
          initialPage={0}
          initialPageSize={20}
          client:idle
        />
      </section>

      <!-- Scraper Status Section -->
      <section class="mb-8">
        <ScraperStatus
          lastSuccessfulScrape={rckik.lastSuccessfulScrape}
          scrapingStatus={rckik.scrapingStatus as any}
          client:load
        />
      </section>
        </>
      )}

    </div>
  </main>
</Layout>

<style>
  /* Global styles dla strony */
  main {
    min-height: calc(100vh - 200px);
  }

  /* Smooth scroll dla anchor links */
  html {
    scroll-behavior: smooth;
  }

  /* Focus visible dla keyboard navigation */
  *:focus-visible {
    outline: 2px solid theme('colors.blue.500');
    outline-offset: 2px;
  }
</style>
